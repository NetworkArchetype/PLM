name: Emergency - Cancel In-Progress Workflows

on:
  workflow_dispatch: {}

permissions:
  actions: write

jobs:
  cancel-in-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel in-progress workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Listing workflow runs..."
          runs=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs?status=in_progress,queued" | jq -r '.workflow_runs[] | "id=\(.id) name=\(.name) status=\(.status) html_url=\(.html_url)"')
          if [ -z "$runs" ]; then echo "No in-progress or queued runs found."; exit 0; fi
          echo "$runs" | while read -r line; do
            id=$(echo "$line" | sed -n 's/.*id=\([0-9]*\).*/\1/p')
            echo "Cancelling run id=$id"
            curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/$id/cancel"
          done
          echo "Done."
